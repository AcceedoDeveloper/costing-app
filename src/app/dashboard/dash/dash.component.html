<div class="dashboard-container">
  <!-- Top Section: Total Quotations -->
  <div class="quotations-section">


    
    <div class="quotations-table-container">
      <div class="table-header">
        <h3 style="margin: 0;">Total Quotations</h3>
        <div class="header-filters">
          <select 
            class="status-filter-select"
            [(ngModel)]="selectedStatus" 
            (change)="onStatusChange()">
            <option *ngFor="let status of statusOptions" [value]="status">
              {{ status }}
            </option>
          </select>
          <div class="month-selector-wrapper">
            <button 
              type="button" 
              class="month-nav-button" 
              (click)="navigateToPreviousMonth()"
              title="Previous Month">
              <mat-icon>chevron_left</mat-icon>
            </button>
            <input 
              type="month" 
              class="date-picker-input" 
              [value]="getMonthInputValue()" 
              (change)="onMonthInputChange($event)">
            <button 
              type="button" 
              class="month-nav-button" 
              (click)="navigateToNextMonth()"
              title="Next Month">
              <mat-icon>chevron_right</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <div class="table-wrapper">
        <div class="table-container">
          <table mat-table [dataSource]="quotationsDataSource" class="quotations-table">
          <!-- Customer Column -->
          <ng-container matColumnDef="customer">
            <th mat-header-cell *matHeaderCellDef>Customer</th>
            <td mat-cell (click)="openDifferenceGraph(row)" class="clickable-difference" *matCellDef="let row" class="customer-cell">{{ row.customer }}</td>
          </ng-container>

          <!-- Email Column -->
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef>Email</th>
            <td mat-cell (click)="openDifferenceGraph(row)" class="clickable-difference" *matCellDef="let row">{{ row.email }}</td>
          </ng-container>

          <!-- Part Name Column -->
          <ng-container matColumnDef="partName">
            <th mat-header-cell *matHeaderCellDef>Part Name</th>
            <td mat-cell (click)="openDifferenceGraph(row)" class="clickable-difference" *matCellDef="let row">{{ row.partName }}</td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell (click)="openDifferenceGraph(row)" class="clickable-difference" *matCellDef="let row">
              <span class="status-badge" [ngClass]="getStatusClass(row.status)">{{ row.status }}</span>
            </td>
          </ng-container>

          <!-- Sent At Column -->
          <ng-container matColumnDef="sentAt">
            <th mat-header-cell *matHeaderCellDef>Sent At</th>
            <td mat-cell (click)="openDifferenceGraph(row)" class="clickable-difference" *matCellDef="let row">{{ row.sentAt }}</td>
          </ng-container>

          <!-- Actual Cost Column -->
          <ng-container matColumnDef="actualCost">
            <th mat-header-cell *matHeaderCellDef>Actual Cost</th>
            <td mat-cell  (click)="openDifferenceGraph(row)" class="clickable-difference" *matCellDef="let row">{{ row.actualCost | number }}</td>
          </ng-container>

          <!-- Difference Column -->
          <ng-container matColumnDef="difference">
            <th mat-header-cell *matHeaderCellDef>Difference</th>
            <td mat-cell *matCellDef="let row" 
                [ngClass]="row.difference >= 0 ? 'difference-cell positive' : 'difference-cell negative'"
                (click)="openDifferenceGraph(row)"
                class="clickable-difference">
              <span class="arrow" [ngClass]="row.difference >= 0 ? 'positive' : 'negative'">
                {{ row.difference >= 0 ? '↑' : '↓' }}
              </span> 
              {{ row.differenceAbs | number }}
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
        </div>

        <mat-paginator 
          [pageSize]="pageSize" 
          [hidePageSize]="true"
          showFirstLastButtons>
        </mat-paginator>
      </div>
    </div>

    <!-- Total Quotations Summary Card -->
    <div class="quotations-summary-card">
      <div class="dashboard-section">

        <div class="section-title">Overall Quotation Data</div>
    
        <div class="quotation-container">
    
            <div class="q-card">
                <h2 class="totalQuotations" >{{ totalQuotations }}</h2>
                <p>Quotations</p>
                <span>100%</span>
            </div>
    
            <div class="q-card">
                <h2 class="approvedCount" >{{ approvedCount }}</h2>
                <p>Approved</p>
                <span>{{ approvedPercent }}%</span>
            </div>
    
            <div class="q-card">
                <h2 class="pendingCount" >{{ pendingCount }}</h2>
                <p>In Progress</p>
                <span>{{ pendingPercent }}%</span>
            </div>
    
               <div class="q-card">
                <h2 class="rejectedCount"  >{{ rejectedCount }}</h2>
                <p>Rejected</p>
                <span>{{ rejectedPercent }}%</span>
            </div>
    
        </div>
    
        <div class="section-title mt">Overall Cost Data</div>
    
        <div class="cost-container">
    
            <div class="cost-card">
                <p class="label">Profit</p>
              <div class="value-row" [ngClass]="totalProfit > 0 ? 'green' : ''">
        <span class="arrow" *ngIf="totalProfit > 0">▲</span>
        <span class="arrow" *ngIf="totalProfit <= 0">▼</span>
        <h2 class="value">{{ formatNumberInK(totalProfit) }}</h2>
        <span class="percent">{{ profitPercent }}%</span>
    </div>
    
            </div>
    
            <div class="cost-card">
                <p class="label">Losses</p>
                <div class="value-row" [ngClass]="totalLosses > 0 ? 'red' : ''">
        <span class="arrow">▼</span>
        <h2 class="value">{{ formatNumberInK(totalLosses) }}</h2>
        <span class="percent">{{ lossesPercent }}%</span>
    </div>
    
                
            </div>
    
            <div class="cost-card">
                <p class="label">Net Difference</p>
              <div class="value-row" [ngClass]="totalCostDifference >= 0 ? 'green' : 'red'">
        <span class="arrow" *ngIf="totalCostDifference >= 0">▲</span>
        <span class="arrow" *ngIf="totalCostDifference < 0">▼</span>
        <h2 class="value">{{ formatNumberInK(getAbsoluteValue(totalCostDifference)) }}</h2>
        <span class="percent">{{ getNetDifferencePercent() }}%</span>
    </div>
    
            </div>
    
        </div>
    </div>
    </div>
  </div>

  <!-- New Dashboard Section -->
  <div class="dashboard-grid">
    <!-- Top Row: Three Charts -->
    <div class="dashboard-row">
      <!-- Grade View (Top Left) -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3>Grade view</h3>
          <div class="chart-controls-wrapper">
            <div class="limit-buttons">
              <button 
                type="button"
                class="limit-button"
                [class.active]="chartDataLimit === 'high'"
                (click)="onChartDataLimitChange('high')"
                title="Show highest values">
                High
              </button>
              <button 
                type="button"
                class="limit-button"
                [class.active]="chartDataLimit === 'low'"
                (click)="onChartDataLimitChange('low')"
                title="Show lowest values">
                Low
              </button>
            </div>
            <select class="grade-select" [(ngModel)]="chartDataSource" (change)="onChartDataSourceChange()">
              <option value="rawMaterial">Raw Material</option>
              <option value="process">Process</option>
              <option value="grade">Grade</option>
            </select>
          
          </div>
        </div>
        <div class="chart-container">
          <div class="donut-chart-wrapper">
            <div class="donut-chart">
              <svg class="donut-svg" viewBox="0 0 200 200">
                <circle 
                  *ngFor="let segment of gradeChartSegments; let i = index"
                  class="donut-segment"
                  [attr.data-index]="i"
                  cx="100" 
                  cy="100" 
                  r="80" 
                  fill="none" 
                  [attr.stroke]="segment.color"
                  stroke-width="30"
                  [attr.stroke-dasharray]="segment.dashArray"
                  [attr.stroke-dashoffset]="segment.dashOffset"
                  stroke-linecap="round">
                </circle>
              </svg>
              <div class="donut-center">
                <div class="center-value-large">{{ gradeTotalValue | number }}</div>
              </div>
            </div>
          </div>
        </div>
        <div class="chart-legend">
          <div *ngFor="let item of gradeChartLegend" class="legend-item">
            <span class="legend-color" [style.background-color]="item.color"></span>
            <span class="legend-label">{{ item.label }}:</span>
            <span class="legend-value">{{ item.value | number }}</span>
            <span class="legend-percent">({{ item.percent }}%)</span>
          </div>
        </div>
      </div>

      <!-- Cost Contribution (Top Middle) -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3>Cost Contribution</h3>
          <input 
            type="month" 
            [value]="getCostContributionMonthValue()"
            (change)="onCostContributionMonthChange($event)"
            class="cost-contribution-month-filter"
            title="Select month to filter cost contribution">
        </div>
        <div class="chart-container">
          <div class="donut-chart-wrapper">
            <div class="donut-chart">
              <svg class="donut-svg" viewBox="0 0 200 200">
                <circle 
                  *ngFor="let segment of costChartSegments; let i = index"
                  class="donut-segment"
                  [attr.data-index]="i"
                  cx="100" 
                  cy="100" 
                  r="80" 
                  fill="none" 
                  [attr.stroke]="segment.color"
                  stroke-width="30"
                  [attr.stroke-dasharray]="segment.dashArray"
                  [attr.stroke-dashoffset]="segment.dashOffset"
                  stroke-linecap="round">
                </circle>
              </svg>
              <div class="donut-center">
                <div class="center-label">Cost Contribution</div>
              </div>
            </div>
          </div>
        </div>
        <div class="chart-legend">
          <div *ngFor="let item of costChartLegend" class="legend-item">
            <span class="legend-color" [style.background-color]="item.color"></span>
            <span class="legend-label">{{ item.label }}:</span>
            <span class="legend-percent">{{ item.percent }}%</span>
          </div>
        </div>
      </div>

      <!-- Quotation Generated Every Month (Top Right) -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3>Quotation Generated Every Month</h3>
          <input 
            type="number" 
            [value]="quotationCountSelectedYear"
            (change)="onQuotationCountYearChange($event)"
            class="quotation-count-year-filter"
            min="2000"
            max="2100"
            placeholder="YYYY"
            title="Select year to filter quotation count">
        </div>
        <div class="chart-container">
          <div class="bar-chart-container">
            <div class="bar-chart">
              <div class="bar-chart-bars">
                <div *ngFor="let bar of quotationBars" class="bar-item">
                  <div class="bar-wrapper">
                    <div 
                      class="bar" 
                      [style.height.%]="bar.percentage"
                      [style.background-color]="bar.color"
                      [title]="bar.month + ': ' + bar.count + ' quotations'">
                    </div>
                  </div>
                  <div class="bar-label">{{ bar.month }}</div>
                </div>
              </div>
              <div class="bar-chart-y-axis">
                <div class="y-axis-label" *ngFor="let label of yAxisLabels">{{ label }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Row: Combined AI Predictor & Material Forecast, Recent Updates -->
    <div class="dashboard-row">
      <!-- Combined AI Cost Predictor and Material Forecast -->
      <div class="dashboard-card combined-ai-card">
        <div class="combined-ai-content">
          <!-- AI Cost Predictor Section -->
          <div class="ai-predictor-section">
            <div class="ai-header">
              <mat-icon class="ai-icon">lightbulb</mat-icon>
              <h3>AI Cost Predictor</h3>
            </div>
            <div class="ai-prediction">
              <p class="prediction-text">{{ aiPrediction }}</p>
            </div>
            <div class="ai-buttons">
              <button class="ai-button" (click)="navigateToSection('raw-material')">
                <span>Raw Material</span>
                <mat-icon>arrow_forward</mat-icon>
              </button>
              <button class="ai-button" (click)="navigateToSection('process')">
                <span>Process</span>
                <mat-icon>arrow_forward</mat-icon>
              </button>
              <button class="ai-button" (click)="navigateToSection('grade')">
                <span>Grade</span>
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          </div>

          <!-- AI-Predicted Material Price Forecast Section -->
          <div class="material-forecast-section">
            <div class="card-header">
              <h3>AI-Predicted Material Price Forecast</h3>
            </div>
            <div class="table-container-forecast">
              <table class="forecast-table">
                <thead>
                  <tr>
                    <th>Material</th>
                    <th>Current Price<br/>({{ currentMonth }})</th>
                    <th>Predicted<br/>June 2025</th>
                    <th>Predicted<br/>Sept 2025</th>
                    <th>Predicted<br/>Dec 2025</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let material of materialForecast">
                    <td class="material-name">{{ material.name }}</td>
                    <td>₹{{ material.currentPrice }}</td>
                    <td>
                      ₹{{ material.junePrice }}
                      <span class="price-change positive" *ngIf="material.juneChange > 0">+{{ material.juneChange }}%</span>
                      <span class="price-change negative" *ngIf="material.juneChange < 0">{{ material.juneChange }}%</span>
                    </td>
                    <td>
                      ₹{{ material.septPrice }}
                      <span class="price-change positive" *ngIf="material.septChange > 0">+{{ material.septChange }}%</span>
                      <span class="price-change negative" *ngIf="material.septChange < 0">{{ material.septChange }}%</span>
                    </td>
                    <td>
                      ₹{{ material.decPrice }}
                      <span class="price-change positive" *ngIf="material.decChange > 0">+{{ material.decChange }}%</span>
                      <span class="price-change negative" *ngIf="material.decChange < 0">{{ material.decChange }}%</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Updates (Bottom Right) -->
      <div class="dashboard-card recent-updates-card">
        <div class="card-header">
          <h3>Recent Updates</h3>
          <div class="date-filter-wrapper">
            <button 
              type="button" 
              class="date-nav-button" 
              (click)="navigateDate(-1)"
              title="Previous day"
              aria-label="Previous day">
              <mat-icon>chevron_left</mat-icon>
            </button>
            <input 
              type="date" 
              [value]="getRecentUpdatesDateValue()"
              (change)="onRecentUpdatesDateChange($event)"
              class="recent-updates-date-filter"
              title="Select date to filter updates">
            <button 
              type="button" 
              class="date-nav-button" 
              (click)="navigateDate(1)"
              title="Next day"
              aria-label="Next day">
              <mat-icon>chevron_right</mat-icon>
            </button>
          </div>
        </div>
        <div class="updates-list" [class.scrollable]="recentUpdates.length > 5">
          <div *ngFor="let update of recentUpdates" class="update-item">
            <div class="update-avatar" [style.background-color]="update.color">
              {{ update.initials }}
            </div>
            <div class="update-content">
              <div class="update-name">{{ update.name }}</div>
              <div class="update-action">
                <span class="action-text">{{ update.action }}</span>
                <span class="action-time" *ngIf="update.time">{{ update.time }}</span>
              </div>
            </div>
          </div>
          <div *ngIf="recentUpdates.length === 0" class="no-updates">
            <p>No recent updates for this date</p>
          </div>
        </div>
      </div>


      
    </div>
  </div>

</div>

