


  <!-- Main Content Area -->
  <div class="main-content">
    

  

    <div class="filter-da" >

      <div class="filter-cards">
        <!-- First Filter Card: Customer, Drawing, Part Name Filters -->
    <div class="filter-card">
      <mat-form-field appearance="outline" class="filter-field" [class.active]="searchFilterType !== 'none'">
        <mat-label>Filter By:</mat-label>
        <mat-select [(ngModel)]="searchFilterType" (selectionChange)="onSearchFilterTypeChange()">
          <mat-option value="none">None</mat-option>
          <mat-option value="customerName">Customer Name</mat-option>
          <mat-option value="drawingNo">Drawing No</mat-option>
          <mat-option value="partNo">Part No</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field" *ngIf="searchFilterType !== 'none'">
        <mat-label>{{ getSearchFilterLabel() }}:</mat-label>
        <mat-select [(ngModel)]="selectedSearchValue" (selectionChange)="onSearchValueChange()">
          <mat-option *ngFor="let option of searchFilterOptions" [value]="option">
            {{ option }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Second Filter Card: Date Filters -->
    <div class="filter-card">
      <mat-form-field appearance="outline" class="filter-field" [class.active]="dateFilterType !== 'none'">
        <mat-label>Date Filter By:</mat-label>
        <mat-select [(ngModel)]="dateFilterType" (selectionChange)="onFilterTypeChange()">
          <mat-option value="none">None</mat-option>
          <mat-option value="date">Date</mat-option>
          <mat-option value="week">Week</mat-option>
          <mat-option value="month">Month</mat-option>
          <mat-option value="year">Year</mat-option>
        </mat-select>
      </mat-form-field>

      <div class="filter-fields" *ngIf="dateFilterType !== 'none'">

        <!-- Custom Date Picker -->
      <div class="filter-field" *ngIf="dateFilterType === 'date'">
        <input 
          type="date" 
          id="singleDate" 
          class="native-input"
          [(ngModel)]="filters.singleDate"
          (change)="onDateChange()">
        <label for="singleDate" class="input-label">Custom Date:</label>
      </div>

      <!-- Week Picker -->
      <div class="filter-field" *ngIf="dateFilterType === 'week'">
        <input 
          type="week" 
          id="weekFilter" 
          class="native-input"
          [(ngModel)]="filters.week"
          (change)="onWeekChange()">
        <label for="weekFilter" class="input-label">Week:</label>
      </div>

      <!-- Month Picker -->
      <div class="filter-field" *ngIf="dateFilterType === 'month'">
        <input 
          type="month" 
          id="monthFilter" 
          class="native-input"
          [(ngModel)]="filters.month"
          (change)="onMonthChange()">
        <label for="monthFilter" class="input-label">Month:</label>
      </div>

      <!-- Year Picker -->
      <div class="filter-field" *ngIf="dateFilterType === 'year'">
        <input 
          type="number" 
          id="yearFilter" 
          class="native-input"
          [class.has-value]="filters.year"
          [(ngModel)]="filters.year"
          placeholder="YYYY"
          min="2000"
          max="2100"
          (change)="onYearChange()">
        <label for="yearFilter" class="input-label">Year:</label>
      </div>
      
      </div>
      
    </div>

      </div>

     <!-- Add Quotation Button -->
     <div class="add-button-wrapper">
      <button mat-raised-button color="primary" class="add-but" (click)="addCustomerDetails()">
        <mat-icon>add</mat-icon>
      </button>
    </div>
    </div>
  

   



    <div class="table-container">
      <table class="data-table">
    <thead>
      <tr>
            <th>ID</th>
        <th>Customer Name</th>
        <th>Drawing No</th>
        <th>Part No</th>
        <th>No of Process</th>
        <th>Revision Count</th>
        <th>Overall Cost</th>
        <th>Download</th>
        <th>Action</th>
        <th>Updated At Time</th>
        <th>Status</th>
       

      </tr>
    </thead>
    <tbody>
          <ng-container *ngFor="let customer of filteredCustomers; let i = index">
            <tr>
              <td>{{ customer.ID || 0 }}</td>
              <td>{{ customer.CustomerName?.name || '-' }}</td>
              <td>{{ customer.drawingNo || '-' }}</td>
              <td>{{ customer.partName || '-' }}</td>
              <td>{{ getProcessCount(customer) }} Process</td>
              <td>{{ getAllRevisions(customer).length }}</td>
              <td>{{ (customer.OverallTotalCost || getRevisionTotalCost(getLatestRevision(customer))) | number:'1.2-2' }}</td>
           
                <td class="download-cell">
                  <div class="combined-button">
                    <div class="view-section" (click)="viewQuotation(customer)">
                      <span>View</span>
                    </div>
                    <div class="download-section" (click)="downloadQuotation(customer)">
                      <span>Download</span>
                    </div>
                  </div>
      </td>
              <td class="action-cell">
                <div class="action-buttons-container">
                  <button mat-icon-button (click)="edit(customer._id)" title="Edit">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button (click)="delete(customer._id)" title="Delete">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
      </td>
      <td>
        {{ customer.updatedAt ? (customer.updatedAt | date:'mediumDate') : (customer.createdAt ? (customer.createdAt | date:'mediumDate') : '-') }}
      </td>
      <td>
        <mat-form-field appearance="outline" class="status-field">
          <mat-select 
            [value]="getStatus(customer)" 
            (selectionChange)="onStatusChange(customer._id, $event.value)">
            <mat-option value="pending">Pending</mat-option>
            <mat-option value="e-mail sent">E-mail Sent</mat-option>
            <mat-option value="approved">Approved</mat-option>
            <mat-option value="rejected">Rejected</mat-option>
          </mat-select>
        </mat-form-field>
      </td>
      
    </tr>
    <!-- Expanded Row with Nested Table -->
    <tr *ngIf="isRowExpanded(customer._id)" class="expanded-row">
      <td colspan="11" class="nested-table-cell">
        <div class="nested-table-container">
          <!-- Revision Toggle Button -->
          <div *ngIf="getAllRevisions(customer).length > 0" style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
            <h4 style="margin: 0; color: var(--imperial-green); font-size: 0.875rem; font-weight: 600;">
              Revisions: {{ getAllRevisions(customer).length }}
            </h4>
            <button mat-button (click)="toggleRevision(customer._id)" style="color: var(--deep-emerald); font-size: 0.75rem;">
              <mat-icon>{{ isRevisionExpanded(customer._id) ? 'expand_less' : 'expand_more' }}</mat-icon>
              {{ isRevisionExpanded(customer._id) ? 'Hide Revisions' : 'Show Revisions' }}
            </button>
          </div>

          <!-- Process Table -->
          <table class="nested-table" style="margin-bottom: 1rem;">
            <thead>
              <tr>
                <th>Process Name</th>
                <th>Process Cost</th>
                <th>Grade</th>
                <th>Process Type</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let process of (getLatestRevision(customer)?.processName || customer.processName); let j = index">
                <td>{{ process.name || process.processName || '-' }}</td>
                <td>{{ process.processCost | number:'1.2-2' }}</td>
                <td>{{ process.grade?.name || process.grade || '-' }}</td>
                <td>{{ process.processType?.name || process.processType || '-' }}</td>
              </tr>
              <tr *ngIf="(!getLatestRevision(customer)?.processName && !customer.processName) || (getLatestRevision(customer)?.processName?.length === 0 && customer.processName?.length === 0)">
                <td colspan="4" class="no-data">No process data available</td>
              </tr>
            </tbody>
          </table>

          <!-- Revision Details -->
          <div *ngIf="isRevisionExpanded(customer._id) && getAllRevisions(customer).length > 0">
            <h4 style="color: var(--imperial-green); font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem;">Revision Cost Details</h4>
            <div *ngFor="let revision of getAllRevisions(customer); let revIndex = index" 
                 style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(229, 227, 221, 0.2); border-radius: 8px; border-left: 3px solid var(--deep-emerald);">
              <h5 style="margin: 0 0 0.75rem 0; color: var(--deep-emerald); font-size: 0.8125rem; font-weight: 600;">
                Revision {{ revIndex + 1 }} 
                <span style="font-size: 0.75rem; color: var(--luxury-grey); font-weight: 400; margin-left: 0.5rem;">
                  ({{ revision.createdAt ? (revision.createdAt | date:'short') : 'N/A' }})
                </span>
              </h5>
              
              <!-- Revision Process Costs -->
              <div style="margin-bottom: 0.75rem;">
                <strong style="font-size: 0.75rem; color: var(--black-pearl);">Total Process Cost:</strong>
                <span style="font-size: 0.8125rem; font-weight: 600; color: var(--imperial-green); margin-left: 0.5rem;">
                  {{ getRevisionTotalCost(revision) | number:'1.2-2' }}
                </span>
              </div>

              <!-- Salary & Wages -->
              <div *ngIf="revision.SalaryAndWages" style="margin-bottom: 0.5rem;">
                <strong style="font-size: 0.75rem; color: var(--black-pearl);">Salary & Wages:</strong>
                <span style="font-size: 0.75rem; color: var(--luxury-grey); margin-left: 0.5rem;">
                  Process: {{ revision.SalaryAndWages.salaryforProcess | number:'1.2-2' }},
                  Excluding Core: {{ revision.SalaryAndWages.salaryExcludingCoreMaking | number:'1.2-2' }},
                  Core Production: {{ revision.SalaryAndWages.salaryForCoreProduction | number:'1.2-2' }}
                </span>
              </div>

              <!-- Overheads -->
              <div *ngIf="revision.OverHeads" style="margin-bottom: 0.5rem;">
                <strong style="font-size: 0.75rem; color: var(--black-pearl);">Overheads:</strong>
                <span style="font-size: 0.75rem; color: var(--luxury-grey); margin-left: 0.5rem;">
                  Total: {{ revision.OverHeads.totalOverHeads | number:'1.2-2' }},
                  With Finance: {{ revision.OverHeads.totalOverHeadsWithFinanceCost | number:'1.2-2' }}
                </span>
              </div>

              <!-- Commercial Terms -->
              <div *ngIf="revision.CommercialTerms" style="margin-bottom: 0.5rem;">
                <strong style="font-size: 0.75rem; color: var(--black-pearl);">Commercial Terms:</strong>
                <span style="font-size: 0.75rem; color: var(--luxury-grey); margin-left: 0.5rem;">
                  Credit Period: {{ revision.CommercialTerms.paymentCreditPeriod }} days,
                  Bank Interest: {{ revision.CommercialTerms.bankInterest }}%
                </span>
              </div>

              <!-- Margin & Rejection -->
              <div style="display: flex; gap: 1rem;">
                <div *ngIf="revision.Margin">
                  <strong style="font-size: 0.75rem; color: var(--black-pearl);">Profit:</strong>
                  <span style="font-size: 0.75rem; color: var(--profit-green); margin-left: 0.25rem; font-weight: 600;">
                    {{ revision.Margin.profit }}%
                  </span>
                </div>
                <div *ngIf="revision.AnticipatedRejection">
                  <strong style="font-size: 0.75rem; color: var(--black-pearl);">Rejection:</strong>
                  <span style="font-size: 0.75rem; color: var(--alert-red); margin-left: 0.25rem; font-weight: 600;">
                    {{ revision.AnticipatedRejection.rejection }}%
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </td>
    </tr>
  </ng-container>
</tbody>
      </table>
      
      <!-- Paginator -->
      <mat-paginator 
        [length]="totalRecords"
        [pageSize]="pageSize"
        [pageIndex]="pageIndex"
        [pageSizeOptions]="pageSizeOptions"
        [showFirstLastButtons]="true"
        (page)="onPageChange($event)"
        class="custom-paginator">
      </mat-paginator>
    </div>
  </div>



