

  <!-- Main Content Area -->

  <div class="main-content">

    



  



    <div class="filter-da" >

      <div class="filter-cards">

        <!-- First Filter Card: Customer, Drawing, Part Name Filters -->

    <div class="filter-card">

      <mat-form-field appearance="outline" class="filter-field" [class.active]="searchFilterType !== 'none'">

        <mat-label>Filter By:</mat-label>

        <mat-select [(ngModel)]="searchFilterType" (selectionChange)="onSearchFilterTypeChange()">

          <mat-option value="none">None</mat-option>

          <mat-option value="customerName">Customer Name</mat-option>

          <mat-option value="drawingNo">Drawing No</mat-option>

          <mat-option value="partNo">Part No</mat-option>

        </mat-select>

      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field" *ngIf="searchFilterType !== 'none'">

        <mat-label>{{ getSearchFilterLabel() }}:</mat-label>

        <mat-select [(ngModel)]="selectedSearchValue" (selectionChange)="onSearchValueChange()">

          <mat-option *ngFor="let option of searchFilterOptions" [value]="option">

            {{ option }}

          </mat-option>

        </mat-select>

      </mat-form-field>

    </div>

    <!-- Second Filter Card: Date Filters -->

    <div class="filter-card">

      <mat-form-field appearance="outline" class="filter-field" [class.active]="dateFilterType !== 'none'">

        <mat-label>Date Filter By:</mat-label>

        <mat-select [(ngModel)]="dateFilterType" (selectionChange)="onFilterTypeChange()">

          <mat-option value="none">None</mat-option>

          <mat-option value="date">Date</mat-option>

          <mat-option value="week">Week</mat-option>

          <mat-option value="month">Month</mat-option>

          <mat-option value="year">Year</mat-option>

        </mat-select>

      </mat-form-field>

      <div class="filter-fields" *ngIf="dateFilterType !== 'none'">

        <!-- Custom Date Picker -->

      <div class="filter-field" *ngIf="dateFilterType === 'date'">

        <input 

          type="date" 

          id="singleDate" 

          class="native-input"

          [(ngModel)]="filters.singleDate"

          (change)="onDateChange()">

        <label for="singleDate" class="input-label">Custom Date:</label>

      </div>

      <!-- Week Picker -->

      <div class="filter-field" *ngIf="dateFilterType === 'week'">

        <input 

          type="week" 

          id="weekFilter" 

          class="native-input"

          [(ngModel)]="filters.week"

          (change)="onWeekChange()">

        <label for="weekFilter" class="input-label">Week:</label>

      </div>

      <!-- Month Picker -->

      <div class="filter-field" *ngIf="dateFilterType === 'month'">

        <input 

          type="month" 

          id="monthFilter" 

          class="native-input"

          [(ngModel)]="filters.month"

          (change)="onMonthChange()">

        <label for="monthFilter" class="input-label">Month:</label>

      </div>

      <!-- Year Picker -->

      <div class="filter-field" *ngIf="dateFilterType === 'year'">

        <input 

          type="number" 

          id="yearFilter" 

          class="native-input"

          [class.has-value]="filters.year"

          [(ngModel)]="filters.year"

          placeholder="YYYY"

          min="2000"

          max="2100"

          (change)="onYearChange()">

        <label for="yearFilter" class="input-label">Year:</label>

      </div>

      </div>

    </div>

      </div>

      <!-- View Toggle and Add Button -->
      <div class="view-toggle-wrapper">
        <div class="view-toggle-container">
          <label class="view-toggle-label">
            <input type="radio" name="viewMode" [value]="'parts'" [(ngModel)]="viewMode" (change)="switchViewMode('parts')" class="view-radio">
            <span class="view-toggle-text">Parts View</span>
          </label>
          <label class="view-toggle-label">
            <input type="radio" name="viewMode" [value]="'customers'" [(ngModel)]="viewMode" (change)="switchViewMode('customers')" class="view-radio">
            <span class="view-toggle-text">Customer View</span>
          </label>
        </div>
      <div class="add-button-wrapper">
       <button mat-raised-button color="primary" class="add-but" (click)="addCustomerDetails()">
         <mat-icon>add</mat-icon>
       </button>
        </div>
     </div>

     </div>

    <div class="table-container">

      <!-- Parts View (Current Table) -->
      <table class="data-table" *ngIf="viewMode === 'parts'">

    <thead>

      <tr>

            <th>ID</th>

        <th>Customer Name</th>

        <th>Drawing No</th>

        <th>Part No</th>

        <th>No of Process</th>

        <th>Revision Count</th>

        <th>Overall Cost</th>

        <th>Download</th>

        <th>Action</th>

        <th>Updated At Time</th>

        <th>Status</th>

      </tr>

    </thead>

    <tbody>

          <ng-container *ngFor="let customer of filteredCustomers; let i = index">

            <tr>

              <td>{{ customer.ID || 0 }}</td>

              <td>{{ customer.CustomerName?.name || '-' }}</td>

              <td>{{ customer.drawingNo || '-' }}</td>

              <td>{{ customer.partName || '-' }}</td>

              <td>{{ getProcessCount(customer) }} Process</td>

              <td>
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                  <span>{{ getAllRevisions(customer).length }}</span>
                  <button 
                    *ngIf="getAllRevisions(customer).length > 1"
                    mat-icon-button 
                    color="accent" 
                    (click)="compareRevisions(customer)"
                    style="width: 32px; height: 32px; line-height: 32px;"
                    matTooltip="Compare Revisions">
                    <mat-icon style="font-size: 18px; height: 18px; width: 18px; line-height: 18px;">compare_arrows</mat-icon>
                  </button>
                </div>
              </td>
              <td>{{ (customer.OverallTotalCost || getRevisionTotalCost(getLatestRevision(customer))) | number:'1.2-2' }}</td>

                <td class="download-cell">

                  <div class="combined-button">

                    <div class="view-section" (click)="viewQuotation(customer)">

                      <span>View</span>

                    </div>

                    <div class="download-section" (click)="downloadQuotation(customer)">

                      <span>Download</span>

                    </div>

                  </div>

      </td>

              <td class="action-cell">

                <div class="action-buttons-container">

                  <button mat-icon-button (click)="toggleRow(customer._id)" title="View Details">

                    <mat-icon>{{ isRowExpanded(customer._id) ? 'expand_less' : 'expand_more' }}</mat-icon>

                  </button>

                  <button mat-icon-button (click)="edit(customer._id)" title="Edit">

                    <mat-icon>edit</mat-icon>

                  </button>

                  <button mat-icon-button (click)="delete(customer._id)" title="Delete">

                    <mat-icon>delete</mat-icon>

                  </button>

                </div>

      </td>

      <td>

        {{ customer.updatedAt ? (customer.updatedAt | date:'mediumDate') : (customer.createdAt ? (customer.createdAt | date:'mediumDate') : '-') }}

      </td>

      <td>

        <mat-form-field appearance="outline" class="status-field">

          <mat-select 

            [value]="getStatus(customer)" 

            (selectionChange)="onStatusChange(customer._id, $event.value)">

            <mat-option value="pending">Pending</mat-option>

            <mat-option value="e-mail sent">E-mail Sent</mat-option>

            <mat-option value="approved">Approved</mat-option>

            <mat-option value="rejected">Rejected</mat-option>

          </mat-select>

        </mat-form-field>

      </td>

    </tr>

    <!-- Expanded Row with Nested Table -->

    <tr *ngIf="isRowExpanded(customer._id)" class="expanded-row">

      <td colspan="11" class="nested-table-cell">

        <div class="nested-table-container">

          <!-- Customer Details Header -->

          <div class="details-header">

            <h4 class="details-title"> Details</h4>

            <div class="revision-selector">
              <!-- Revision Checkboxes -->
              <div *ngIf="getAllRevisions(customer).length > 0" class="revision-checkboxes-container">
                <div class="revision-checkboxes-wrapper">
                  <div class="revision-checkboxes">
                    <label *ngFor="let revision of getAllRevisions(customer); let i = index" class="revision-checkbox-label">
                      <input 
                        type="checkbox" 
                        [checked]="isRevisionSelectedForComparison(customer._id, i)"
                        (change)="toggleRevisionForComparison(customer._id, i)"
                        class="revision-checkbox">
                      <span class="revision-checkbox-text">
                        Rev {{ i + 1 }}
                        <span *ngIf="revision.createdAt" class="revision-date-small">
                          ({{ revision.createdAt | date:'shortDate' }})
                        </span>
                      </span>
                    </label>
                  </div>
                </div>
                <button 
                  mat-raised-button 
                  color="primary"
                  [disabled]="getSelectedRevisionsCount(customer._id) < 2"
                  (click)="openCompareWithSelectedRevisions(customer)"
                  class="compare-revisions-btn"
                  [class.disabled]="getSelectedRevisionsCount(customer._id) < 2">
                  <mat-icon>compare_arrows</mat-icon>
                  Compare Revisions ({{ getSelectedRevisionsCount(customer._id) }})
                </button>
              </div>
            </div>
          </div>

          <!-- Revisions Table -->
          <div class="details-section">

            <table class="nested-table">

              <thead>

                <tr>

                  <th>Revision</th>
                  <th>Total Process Cost</th>
                  <th>Subtotal Metal</th>
                  <th>Sub Total Labour</th>
                  <th>Sub Total Power</th>

                  <th>Process Name</th>
                  <th>Inputs</th>
                </tr>

              </thead>

              <tbody>

                <!-- Show all revisions -->
                <ng-container *ngIf="getAllRevisions(customer).length > 0">
                  <tr *ngFor="let revision of getAllRevisions(customer); let i = index">
                    <td>
                      <div class="revision-number-badge">Rev {{ i + 1 }}</div>
                      <div *ngIf="revision.createdAt" class="revision-date-text">
                        {{ revision.createdAt | date:'shortDate' }}
                      </div>
                    </td>
                    <td>
                      {{ (revision.totalProcessCost || 0) | number:'1.2-2' }}
                    </td>
                    <td>
                      {{ getSubtotalMetal(customer) | number:'1.2-2' }}
                    </td>
                    <td>
                      {{ getSubtotalLabour(customer) | number:'1.2-2' }}
                    </td>
                    <td>
                      {{ getSubtotalPower(customer) | number:'1.2-2' }}
                    </td>
                    <td>
                      <div class="process-names-list" *ngIf="revision.processName && revision.processName.length > 0">
                        <div *ngFor="let process of revision.processName; let last = last" class="process-name-item">
                          {{ process.name || process.processName || '-' }}
                          <span *ngIf="!last">, </span>
                        </div>
                      </div>
                      <div *ngIf="!revision.processName || revision.processName.length === 0" class="no-process">
                        -
                      </div>
                    </td>
                   
                    <td>
                      <div class="inputs-container">
                        <div class="input-badge casting" *ngIf="revision.castingInputs || customer.castingInputs">
                          <mat-icon class="input-icon">settings</mat-icon>
                          <span>Casting</span>
                        </div>
                        <div class="input-badge moulding" *ngIf="revision.mouldingInputs || customer.mouldingInputs">
                          <mat-icon class="input-icon">build</mat-icon>
                          <span>Moulding</span>
                        </div>
                        <div class="input-badge core" *ngIf="revision.coreInputs || customer.coreInputs">
                          <mat-icon class="input-icon">category</mat-icon>
                          <span>Core</span>
                        </div>
                        <div *ngIf="!revision.castingInputs && !customer.castingInputs && !revision.mouldingInputs && !customer.mouldingInputs && !revision.coreInputs && !customer.coreInputs" class="no-inputs">
                          -
                        </div>
                      </div>
                    </td>
                  </tr>
                </ng-container>
                <!-- Fallback if no revisions, show root customer data -->
                <tr *ngIf="getAllRevisions(customer).length === 0">
                  <td>
                    <div class="revision-number-badge">Initial</div>
                  </td>
                  <td>
                    {{ (customer.totalProcessCost || 0) | number:'1.2-2' }}
                  </td>
                  <td>
                    {{ getSubtotalMetal(customer) | number:'1.2-2' }}
                  </td>
                  <td>
                    {{ getSubtotalLabour(customer) | number:'1.2-2' }}
                  </td>
                  <td>
                    {{ getSubtotalPower(customer) | number:'1.2-2' }}
                  </td>
                  <td>
                    <div class="process-names-list" *ngIf="customer.processName && customer.processName.length > 0">
                      <div *ngFor="let process of customer.processName; let last = last" class="process-name-item">
                        {{ process.name || process.processName || '-' }}
                        <span *ngIf="!last">, </span>
                      </div>
                    </div>
                    <div *ngIf="!customer.processName || customer.processName.length === 0" class="no-process">
                      -
                    </div>
                  </td>
                  <td>
                    <div class="inputs-container">
                      <div class="input-badge casting" *ngIf="customer.castingInputs">
                        <mat-icon class="input-icon">settings</mat-icon>
                        <span>Casting</span>
                      </div>
                      <div class="input-badge moulding" *ngIf="customer.mouldingInputs">
                        <mat-icon class="input-icon">build</mat-icon>
                        <span>Moulding</span>
                      </div>
                      <div class="input-badge core" *ngIf="customer.coreInputs">
                        <mat-icon class="input-icon">category</mat-icon>
                        <span>Core</span>
                      </div>
                      <div *ngIf="!customer.castingInputs && !customer.mouldingInputs && !customer.coreInputs" class="no-inputs">
                        -
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

        </div>

      </td>

    </tr>

  </ng-container>

</tbody>

      </table>

      <!-- Paginator for Parts View -->

      <mat-paginator 
        *ngIf="viewMode === 'parts'"
        [length]="totalRecords"
        [pageSize]="pageSize"
        [pageIndex]="pageIndex"
        [pageSizeOptions]="pageSizeOptions"
        [showFirstLastButtons]="true"
        (page)="onPageChange($event)"
        class="custom-paginator">
      </mat-paginator>

      <!-- Customer View (New Table) -->
      <table class="data-table customer-view-table" *ngIf="viewMode === 'customers'">
        <thead>
          <tr>
            <th>Customer Name</th>
            <th style="text-align: right;">Total Parts</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let customerName of getCustomerNames()">
            <!-- Customer Row -->
            <tr class="customer-row" (click)="toggleCustomer(customerName)" >
              <td style="font-weight: 600; color: rgba(11, 59, 46, 0.8);">{{ customerName }}</td>
              <td style="text-align: right; position: relative;">
                <span class="part-count-badge">
                  {{ getPartCount(customerName) }} Part{{ getPartCount(customerName) !== 1 ? 's' : '' }}
                  <button mat-icon-button (click)="toggleCustomer(customerName)" title="Expand/Collapse" class="customer-expand-btn">
                    <mat-icon>{{ isCustomerExpanded(customerName) ? 'expand_less' : 'expand_more' }}</mat-icon>
                  </button>
                </span>
              </td>
            </tr>
            
            <!-- Expanded Customer: Show Parts -->
            <tr *ngIf="isCustomerExpanded(customerName)" class="expanded-customer-row">
              <td colspan="2" class="nested-table-cell">
                <div class="nested-table-container">
                  <div class="details-header">
                    <h4 class="details-title">Parts for {{ customerName }}</h4>
                  </div>
                  
                  <ng-container *ngFor="let partName of getPartNameGroups(customerName)">
                    <!-- PartName Group Container -->
                    <div class="partname-group-container">
                      <!-- PartName Group Header Row -->
                      <div class="partname-group-header" (click)="togglePartNameGroup(customerName, partName)">
                       
                        <span class="partname-group-badge">{{ partName }}</span>
                        <span class="partname-count-badge">{{ getPartNameGroupCount(customerName, partName) }} Part{{ getPartNameGroupCount(customerName, partName) !== 1 ? 's' : '' }}
                          <button mat-icon-button title="Expand/Collapse Part Name Group">
                            <mat-icon>{{ isPartNameGroupExpanded(customerName, partName) ? 'expand_less' : 'expand_more' }}</mat-icon>
                          </button>
                        </span>
                      </div>
                      
                      <!-- Expanded PartName Group: Show table with parts -->
                      <div *ngIf="isPartNameGroupExpanded(customerName, partName)" class="partname-group-content">
                        <table class="nested-table parts-table">
                          <thead>
                            <tr>
                              <th style="width: 12%;">Drawing No</th>
                              <th style="width: 10%;">No of Process</th>
                              <th style="width: 10%;">Revision Count</th>
                              <th style="width: 10%;">Overall Cost</th>
                              <th style="width: 12%;">Download</th>
                              <th style="width: 12%;">Action</th>
                              <th style="width: 12%;">Updated At</th>
                              <th style="width: 12%;">Status</th>
                            </tr>
                          </thead>
                          <tbody>
                            <ng-container *ngFor="let part of getPartsByPartName(customerName, partName)">
                              <!-- Part Row -->
                              <tr class="part-row">
                                <td>{{ part.drawingNo || '-' }}</td>
                                <td>{{ getProcessCount(part) }} Process</td>
                                <td>
                                  <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span>{{ getAllRevisions(part).length }}</span>
                                    <button 
                                      *ngIf="getAllRevisions(part).length > 1"
                                      mat-icon-button 
                                      color="accent" 
                                      (click)="compareRevisions(part)"
                                      style="width: 32px; height: 32px; line-height: 32px;"
                                      matTooltip="Compare Revisions">
                                      <mat-icon style="font-size: 18px; height: 18px; width: 18px; line-height: 18px;">compare_arrows</mat-icon>
                                    </button>
                                  </div>
                                </td>
                                <td>{{ (part.OverallTotalCost || getRevisionTotalCost(getLatestRevision(part))) | number:'1.2-2' }}</td>
                                <td class="download-cell">
                                  <div class="combined-button">
                                    <div class="view-section" (click)="viewQuotation(part)">
                                      <span>View</span>
                                    </div>
                                    <div class="download-section" (click)="downloadQuotation(part)">
                                      <span>Download</span>
                                    </div>
                                  </div>
                                </td>
                                <td class="action-cell">
                                  <div class="action-buttons-container">
                                    <button mat-icon-button (click)="togglePart(part)" title="Expand/Collapse Details" *ngIf="getAllRevisions(part).length > 0">
                                      <mat-icon>{{ isPartExpanded(part) ? 'expand_less' : 'expand_more' }}</mat-icon>
                                    </button>
                                    <button mat-icon-button (click)="edit(part._id)" title="Edit">
                                      <mat-icon>edit</mat-icon>
                                    </button>
                                    <button mat-icon-button (click)="delete(part._id)" title="Delete">
                                      <mat-icon>delete</mat-icon>
                                    </button>
                                  </div>
                                </td>
                                <td>
                                  {{ part.updatedAt ? (part.updatedAt | date:'mediumDate') : (part.createdAt ? (part.createdAt | date:'mediumDate') : '-') }}
                                </td>
                                <td>
                                  <mat-form-field appearance="outline" class="status-field">
                                    <mat-select 
                                      [value]="getStatus(part)" 
                                      (selectionChange)="onStatusChange(part._id, $event.value)">
                                      <mat-option value="pending">Pending</mat-option>
                                      <mat-option value="e-mail sent">E-mail Sent</mat-option>
                                      <mat-option value="approved">Approved</mat-option>
                                      <mat-option value="rejected">Rejected</mat-option>
                                    </mat-select>
                                  </mat-form-field>
                                </td>
                              </tr>
                              
                              <!-- Expanded Part: Show Revision Details -->
                              <tr *ngIf="isPartExpanded(part) && getAllRevisions(part).length > 0" class="expanded-part-row">
                                <td colspan="10" class="nested-table-cell">
                                  <div class="nested-table-container">
                                    <div class="details-header">
                                      <h4 class="details-title">Revision Details for {{ part.partName }}</h4>
                                      <div class="revision-selector">
                                        <div *ngIf="getAllRevisions(part).length > 0" class="revision-checkboxes-container">
                                          <div class="revision-checkboxes-wrapper">
                                            <div class="revision-checkboxes">
                                              <label *ngFor="let revision of getAllRevisions(part); let i = index" class="revision-checkbox-label">
                                                <input 
                                                  type="checkbox" 
                                                  [checked]="isRevisionSelectedForComparison(part._id, i)"
                                                  (change)="toggleRevisionForComparison(part._id, i)"
                                                  class="revision-checkbox">
                                                <span class="revision-checkbox-text">
                                                  Rev {{ i + 1 }}
                                                  <span *ngIf="revision.createdAt" class="revision-date-small">
                                                    ({{ revision.createdAt | date:'shortDate' }})
                                                  </span>
                                                </span>
                                              </label>
                                            </div>
                                          </div>
                                          <button 
                                            mat-raised-button 
                                            color="primary"
                                            [disabled]="getSelectedRevisionsCount(part._id) < 2"
                                            (click)="openCompareWithSelectedRevisions(part)"
                                            class="compare-revisions-btn"
                                            [class.disabled]="getSelectedRevisionsCount(part._id) < 2">
                                            <mat-icon>compare_arrows</mat-icon>
                                            Compare Revisions ({{ getSelectedRevisionsCount(part._id) }})
                                          </button>
                                        </div>
                                      </div>
                                    </div>
                                    <div class="details-section">
                                      <table class="nested-table">
                                        <thead>
                                          <tr>
                                            <th>Revision</th>
                                            <th>Total Process Cost</th>
                                            <th>Subtotal Metal</th>
                                            <th>Sub Total Labour</th>
                                            <th>Sub Total Power</th>
                                            <th>Process Name</th>
                                            <th>Inputs</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          <ng-container *ngIf="getAllRevisions(part).length > 0">
                                            <tr *ngFor="let revision of getAllRevisions(part); let i = index">
                                              <td>
                                                <div class="revision-number-badge">Rev {{ i + 1 }}</div>
                                                <div *ngIf="revision.createdAt" class="revision-date-text">
                                                  {{ revision.createdAt | date:'shortDate' }}
                                                </div>
                                              </td>
                                              <td>
                                                {{ (revision.totalProcessCost || 0) | number:'1.2-2' }}
                                              </td>
                                              <td>
                                                {{ getSubtotalMetal(part) | number:'1.2-2' }}
                                              </td>
                                              <td>
                                                {{ getSubtotalLabour(part) | number:'1.2-2' }}
                                              </td>
                                              <td>
                                                {{ getSubtotalPower(part) | number:'1.2-2' }}
                                              </td>
                                              <td>
                                                <div class="process-names-list" *ngIf="revision.processName && revision.processName.length > 0">
                                                  <div *ngFor="let process of revision.processName; let last = last" class="process-name-item">
                                                    {{ process.name || process.processName || '-' }}
                                                    <span *ngIf="!last">, </span>
                                                  </div>
                                                </div>
                                                <div *ngIf="!revision.processName || revision.processName.length === 0" class="no-process">
                                                  -
                                                </div>
                                              </td>
                                              <td>
                                                <div class="inputs-container">
                                                  <div class="input-badge casting" *ngIf="revision.castingInputs || part.castingInputs">
                                                    <mat-icon class="input-icon">settings</mat-icon>
                                                    <span>Casting</span>
                                                  </div>
                                                  <div class="input-badge moulding" *ngIf="revision.mouldingInputs || part.mouldingInputs">
                                                    <mat-icon class="input-icon">build</mat-icon>
                                                    <span>Moulding</span>
                                                  </div>
                                                  <div class="input-badge core" *ngIf="revision.coreInputs || part.coreInputs">
                                                    <mat-icon class="input-icon">category</mat-icon>
                                                    <span>Core</span>
                                                  </div>
                                                  <div *ngIf="!revision.castingInputs && !part.castingInputs && !revision.mouldingInputs && !part.mouldingInputs && !revision.coreInputs && !part.coreInputs" class="no-inputs">
                                                    -
                                                  </div>
                                                </div>
                                              </td>
                                            </tr>
                                          </ng-container>
                                        </tbody>
                                      </table>
                                    </div>
                                  </div>
                                </td>
                              </tr>
                            </ng-container>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </ng-container>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>

      <!-- Paginator for Customer View -->
      <mat-paginator 
        *ngIf="viewMode === 'customers'"
        [length]="totalRecords"
        [pageSize]="pageSize"
        [pageIndex]="pageIndex"
        [pageSizeOptions]="pageSizeOptions"
        [showFirstLastButtons]="true"
        (page)="onPageChange($event)"
        class="custom-paginator">
      </mat-paginator>

    </div>

  </div>
